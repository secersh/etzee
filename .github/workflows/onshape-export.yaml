name: ðŸ¤– Export 3D Models from Onshape

on:
  workflow_dispatch:
    
jobs:
  export-3D-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo apt-get update && sudo apt-get install -y yq

      - name: Export STL files
        working-directory: manufacturing/3d-printing
        run: |
          AUTH=$(echo -n "${{ secrets.ONSHAPE_ACCESS_KEY }}:${{ secrets.ONSHAPE_SECRET_KEY }}" | base64)

          yq -c '.documents[]' part-numbers.yaml | while read doc; do
            DID=$(echo "$doc" | yq -r '.id')
            WID=$(echo "$doc" | yq -r '.workspace')

            echo "$doc" | yq -c '.elements[]' | while read elem; do
              EID=$(echo "$elem" | yq -r '.id')

              echo "$elem" | yq -c '.parts[]' | while read partNameRaw; do
                PART_NAME=$(echo "$partNameRaw" | sed 's/^"\(.*\)"$/\1/')

                echo "$AUTH, Exporting $PART_NAME from document $DID, workspace $WID, element $EID"

              done
            done
          done

      - name: Commit STL files
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add manufacturing/3d-printing/*.stl
          git commit -m "Exported STL files from Onshape"
          git push
