name: ü§ñ Export 3D Models from Onshape

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        required: true
        description: "Keyboard switches profile"
        default: "Normal"
        options:
          - Normal
          - Low
      columns:
        type: choice
        required: true
        description: "Number of keyboard columns"
        default: "6"
        options:
          - "5"
          - "6"
    
jobs:
  export-3D-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get parts list
        run: |
          AUTH=$(printf "%s:%s" "${{ secrets.ONSHAPE_API_ACCESS_KEY }}" "${{ secrets.ONSHAPE_API_SECRET_KEY }}" | base64 | tr -d '\n')

          ENCODED_CONFIG=$(jq -rn \
          --arg profile "${{ inputs.profile }}" \
          --arg columns "${{ inputs.columns }}" \
          '$ARGS.named | "List_kw1ECqDsNAkjBg=\($profile),List_kw1ECqDsNAkjBg=\($columns)" | @uri')

          echo "üîç Fetching parts list with assigned part numbers from Onshape..."

          curl -X 'GET' \
          "https://cad.onshape.com/api/v10/parts/d/${{ vars.DID }}/w/${{ vars.WVMID }}/e/${{ vars.EID }}"\
          ?includeFlatParts=true"\
          &configuration=$ENCODED_CONFIG" \
          -H "accept: application/json" \
          -H "Authorization: Basic $AUTH" \
          | jq '[.[] | select(.partNumber != null and .partNumber != "") | {partId, partNumber}]'

      - name: Commit STL files
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add manufacturing/3d-printing/*.stl
          git commit -m "Exported STL files from Onshape"
          git push
