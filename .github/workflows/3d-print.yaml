name: üñ® generate-3D-models

on:
  workflow_dispatch:
    
jobs:
  export-3D-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install yq
        run: |
          sudo apt-get update && sudo apt-get install -y yq

      - name: Export STL files
        env:
          ACCESS_KEY: ${{ secrets.ONSHAPE_ACCESS_KEY }}
          SECRET_KEY: ${{ secrets.ONSHAPE_SECRET_KEY }}
        working-directory: manufacturing/3d-printing
        run: |
          AUTH=$(echo -n "${ACCESS_KEY}:${SECRET_KEY}" | base64)

          yq -c '.documents[]' parts-list.yaml | while read doc; do
            DID=$(echo "$doc" | yq -r '.id')
            WID=$(echo "$doc" | yq -r '.workspace')

            echo "$doc" | yq -c '.elements[]' | while read elem; do
              EID=$(echo "$elem" | yq -r '.id')

              PARTS_JSON=$(curl -sSL -X GET "https://cad.onshape.com/api/v10/parts/d/${DID}/w/${WID}/e/${EID}?withThumbnails=false&includePropertyDefaults=false&includeFlatParts=true" \
                -H "Authorization: Basic ${AUTH}" \
                -H "Accept: application/json")

              echo "$elem" | yq -c '.parts[]' | while read partNameRaw; do
                PART_NAME=$(echo "$partNameRaw" | sed 's/^"\(.*\)"$/\1/')

                PARTID=$(echo "$PARTS_JSON" | jq -r --arg name "$PART_NAME" '.[] | select(.name == $name) | .partId' | head -n 1)

                if [ -z "$PARTID" ] || [ "$PARTID" = "null" ]; then
                  echo "‚ö†Ô∏è Part '$PART_NAME' not found in element $EID"
                  continue
                fi

                SAFE_NAME=$(echo "$PART_NAME" | tr ' /' '__')
                FILENAME="${SAFE_NAME}__${PARTID}.stl"

                URL="https://cad.onshape.com/api/v10/parts/d/${DID}/w/${WID}/e/${EID}/partid/${PARTID}/stl?mode=text&grouping=true&scale=1&units=inch"

                curl -sSL -X GET "$URL" \
                  -H "Authorization: Basic ${AUTH}" \
                  -H "accept: application/octet-stream" \
                  -o "$FILENAME"
              done
            done
          done

      - name: Commit STL files
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add manufacturing/3d-printing/*.stl
          git commit -m "Exported STL files from Onshape"
          git push
